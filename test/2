import socket

HOST = 'localhost'
PORT = 8000

sockets = []

server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server_socket.bind((HOST,PORT))
server_socket.listen(2)
conn, addr = s.accept()
sockets.append(s)

import threading

class SocketThread(threading.Thread):
    def __init__(self,socket,*args,**kwargs):
        super(SocketThread, self).__init__(*args,**kwargs)
        self._kill = threading.Event()
    
    def kill(self):
        self._kill.set()

    def alive(self):
        return not self._kill.isSet()
    
import re

def parse_conn_info(msg):
    exp = r'(\d+?\.\d+?\.\d+?\.\d+?):(\d+?)'
    m = re.search(exp,msg)
    if m.matches():
        return m.group(0), m.group(1)
    return -1,-1

def broadcast(msgs,socks):
    for msg in msgs:
        for sock in socks:
            sock.send(msg)


q = []

print server_socket.getsockname()

while True:
    for sock in sockets:
        if sock == server_socket:
            try:
                msg = sock.recv(64)
                addr = parse_conn_info(msg)
                s = socket.socket(AF_INET,SOCK_STREAM)
                s.connect(addr)
                sockets.append(s)
            except:
                print "Failed connection"
        else:
            msg = sock.recv(64)
            print sock.getsockname(),msg
            q.append(msg)
    broadcast(q,sockets)
            
            

conn.close()

           
